<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Commandes & Contacts</title>
<style>
    body { font-family: Arial, sans-serif; padding: 20px; background-color: #f4f4f4; }
    h1 { text-align: center; margin-bottom: 40px; }
    .container { display: flex; gap: 40px; }
    .column { flex: 1; background-color: #fff; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-radius: 8px; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background-color: #3498db; color: white; }
    input[type="text"], input[type="number"], select, input[type="date"] { width: 100%; padding: 5px; box-sizing: border-box; }
    button { padding: 6px 12px; background-color: #2ecc71; color: white; border: none; border-radius: 4px; cursor: pointer; }
    button:hover { background-color: #27ae60; }
</style>
</head>
<body>

<h1>Gestion Commandes & Contacts</h1>
<button style="padding:10px 20px; background-color:#3498db; color:white; border:none; border-radius:5px; cursor:pointer;" onclick="window.location.href='index.html'">Retour</button>

<div class="container">
    <!-- Commandes -->
    <div class="column">
        <h2>Commandes</h2>
        <table id="ordersTable">
            <thead>
                <tr>
                    <th>Groupe</th>
                    <th>Arme</th>
                    <th>Quantité</th>
                    <th>Livrée</th>
                    <th>Date</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <button onclick="addOrderRow()">Ajouter une commande</button>
    </div>

    <!-- Contacts -->
    <div class="column">
        <h2>Contacts</h2>
        <table id="contactsTable">
            <thead>
                <tr>
                    <th>Groupe</th>
                    <th>Lead</th>
                    <th>Co-lead</th>
                    <th>Gérant</th>
                    <th>Assistant</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

// Supabase
const SUPABASE_URL = "https://ldhxyloqdtplevdkgnah.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxkaHh5bG9xZHRwbGV2ZGtnbmFoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEyMTg5NjAsImV4cCI6MjA3Njc5NDk2MH0.pnoppZtVEP3uDrMEfauPAMMB93EmGO5Ur1pg4OY99-o"; // <-- Remplace par ta clé
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// Liste des armes disponibles
const armesDisponibles = ["AK-47","TEC-9","Canon Scié","SNS","Double Action","Mini SMG + Micro SMG","Gusenberg","Pistolet Perfo","AKU","WM29","STG","UZI","MK-2","Double Canon","Pistolet Lourd","SMG Tactic","Cal .50","AK-S","Beretta","Pistolet Vintage","AIR-7"];

// --- Code couleur quantité ---
function getQuantityColor(quantity) {
    if(quantity <= 0) return 'red';
    if(quantity <= 5) return 'orange';
    return 'green';
}

// --- Commandes ---
async function fetchOrders() {
    const { data, error } = await supabase.from('orders').select('*');
    if(error){ console.error(error); return; }

    const tbody = document.querySelector("#ordersTable tbody");
    tbody.innerHTML = '';
    data.forEach(order => {
        const tr = document.createElement('tr');

        // couleur de la quantité
        const quantityColor = getQuantityColor(order.quantity);
        const deliveredBg = order.delivered ? '#d4edda' : '#f8d7da'; // vert clair / rouge clair

        tr.innerHTML = `
            <td><input type="text" value="${order.group}" /></td>
            <td>
                <select>${armesDisponibles.map(a => `<option value="${a}" ${a===order.weapon?'selected':''}>${a}</option>`)}</select>
            </td>
            <td style="background-color:${quantityColor};"><input type="number" value="${order.quantity}" /></td>
            <td style="background-color:${deliveredBg};"><input type="checkbox" ${order.delivered ? 'checked':''} /></td>
            <td><input type="date" value="${order.date ? order.date.split('T')[0] : ''}" /></td>
            <td><button onclick="updateOrder('${order.id}', this)">Sauvegarder</button></td>
        `;
        tbody.appendChild(tr);
    });
}

window.updateOrder = async function(id, btn) {
    const tr = btn.closest('tr');
    const group = tr.children[0].querySelector('input').value;
    const weapon = tr.children[1].querySelector('select').value;
    const quantity = parseInt(tr.children[2].querySelector('input').value) || 0;
    const delivered = tr.children[3].querySelector('input').checked;
    const date = tr.children[4].querySelector('input').value;

    const { error } = await supabase.from('orders')
        .update({ group, weapon, quantity, delivered, date })
        .eq('id', id);

    if(error) alert('Erreur : ' + error.message);
    else { alert('Commande modifiée !'); fetchOrders(); }
}

window.addOrderRow = function() {
    const tbody = document.querySelector("#ordersTable tbody");
    const tr = document.createElement('tr');
    tr.innerHTML = `
        <td><input type="text" placeholder="Nom du groupe" /></td>
        <td>
            <select>${armesDisponibles.map(a => `<option value="${a}">${a}</option>`)}</select>
        </td>
        <td><input type="number" value="1" /></td>
        <td><input type="checkbox" /></td>
        <td><input type="date" /></td>
        <td><button onclick="saveNewOrder(this)">Ajouter</button></td>
    `;
    tbody.appendChild(tr);
}

window.saveNewOrder = async function(btn) {
    const tr = btn.closest('tr');
    const group = tr.children[0].querySelector('input').value;
    const weapon = tr.children[1].querySelector('select').value;
    const quantity = parseInt(tr.children[2].querySelector('input').value) || 0;
    const delivered = tr.children[3].querySelector('input').checked;
    const date = tr.children[4].querySelector('input').value;

    const { data, error } = await supabase.from('orders')
        .insert([{ group, weapon, quantity, delivered, date }]);

    if(error) alert('Erreur : ' + error.message);
    else { alert('Commande ajoutée !'); fetchOrders(); }
}

// --- Contacts ---
async function fetchContacts() {
    const { data, error } = await supabase.from('contacts').select('*');
    if(error){ console.error(error); return; }

    const tbody = document.querySelector("#contactsTable tbody");
    tbody.innerHTML = '';
    data.forEach(contact => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${contact.group}</td>
            <td>${contact.lead}</td>
            <td>${contact.co_lead}</td>
            <td>${contact.manager}</td>
            <td>${contact.assistant}</td>
        `;
        tbody.appendChild(tr);
    });
}

// --- Initialisation ---
fetchOrders();
fetchContacts();
</script>
</body>
</html>
