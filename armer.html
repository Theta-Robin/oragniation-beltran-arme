<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gestionnaire Armes / Production ‚Äî Mobile & Dark</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Google font (optionnel, donne un look plus pro) -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg: #f8f9fa;
      --card-bg: #ffffff;
      --text: #111827;
      --muted: #6c757d;
      --primary: #0d6efd;
      --success: #198754;
      --surface-shadow: 0 6px 18px rgba(20,20,30,0.04);
      --radius: 12px;
    }
    /* dark theme variables */
    .theme-dark {
      --bg: #0b0d10;
      --card-bg: #0f1417;
      --text: #e6eef3;
      --muted: #9aa6b0;
      --primary: #7aa2ff;
      --success: #5ec48f;
      --surface-shadow: 0 8px 24px rgba(0,0,0,0.6);
    }

    html,body { height:100%; }
    body {
      background: radial-gradient(1200px 400px at 10% 10%, rgba(13,110,253,0.04), transparent),
                  radial-gradient(800px 300px at 90% 90%, rgba(25,135,84,0.02), transparent),
                  var(--bg);
      color: var(--text);
      font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      padding-bottom: 40px;
    }

    .container { max-width:1100px; }

    .app-header {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: .9rem 1rem;
      border-radius: var(--radius);
      background: linear-gradient(90deg, rgba(13,110,253,0.12), rgba(25,135,84,0.06));
      box-shadow: var(--surface-shadow);
      margin-bottom: 1rem;
    }

    h2.app-title {
      margin:0;
      font-weight:700;
      font-size:1.05rem;
      letter-spacing:0.2px;
    }

    .theme-toggle {
      display:inline-flex;
      align-items:center;
      gap:8px;
      background:transparent;
      border:1px solid rgba(255,255,255,0.06);
      padding:6px 10px;
      border-radius: 999px;
      cursor:pointer;
      color:var(--text);
      font-weight:600;
    }

    .card {
      background: var(--card-bg);
      border: none;
      border-radius: calc(var(--radius) - 2px);
      box-shadow: var(--surface-shadow);
    }

    .card-header { font-weight: 700; background: transparent; color: var(--text); padding-top: .8rem; padding-bottom:.8rem; }

    .small-muted, .muted-note { font-size: .85rem; color: var(--muted); }

    .mobile-card { margin-bottom: 0.75rem; padding: .85rem; border-radius: .6rem; background: var(--card-bg); box-shadow: var(--surface-shadow); }
    .mobile-row { display:flex; gap:0.5rem; align-items:center; flex-wrap:wrap; }
    .mobile-row > * { flex: 1 1 45%; min-width: 120px; }
    .mobile-actions { display:flex; gap:0.5rem; justify-content:flex-end; margin-top:0.5rem; }

    .table-small { font-size:0.95rem; }
    @media (max-width: 767.98px) {
      .desktop-only { display: none !important; }
      .mobile-only { display: block !important; }
      input[type="number"] { width: 100%; }
    }
    @media (min-width: 768px) {
      .mobile-only { display: none !important; }
      .desktop-only { display: block !important; }
    }

    .form-control { min-height: calc(1.4em + 0.8rem + 2px); padding: .4rem .6rem; background: transparent; color: var(--text); border-radius: 8px; border:1px solid rgba(0,0,0,0.06); }
    .form-control::placeholder { color:var(--muted); opacity:0.8; }
    input:focus, select:focus, textarea:focus { outline: none; box-shadow: 0 4px 18px rgba(13,110,253,0.08); border-color: rgba(13,110,253,0.4); }

    .btn-primary { background: linear-gradient(180deg,var(--primary), rgba(0,0,0,0.06)); border: none; }
    .btn-danger { background: linear-gradient(180deg,#ff6b6b,#e55); border: none; }
    .btn-sm { padding: .35rem .6rem; border-radius: 8px; }

    /* subtle helpers */
    .muted-pill { font-size:.8rem; color:var(--muted); background:rgba(0,0,0,0.03); padding:.25rem .5rem; border-radius:999px; }

    /* make checkboxes clearer */
    .form-check-input { width:1.2rem; height:1.2rem; }

    /* -------------------------
       PRODUCTION: gris√© par d√©faut, fort au focus
       ------------------------- */
    .production-input {
      color: var(--muted);                 /* gris√© par d√©faut */
      transition: color .12s ease, font-weight .12s ease, box-shadow .12s ease;
      font-weight: 500;
    }
    .production-input::placeholder { color: var(--muted); opacity:0.9; }
    .production-input:focus {
      color: var(--text);                  /* devient fort au focus */
      font-weight: 700;
      box-shadow: 0 8px 22px rgba(13,110,253,0.08);
      border-color: rgba(13,110,253,0.25);
    }
  </style>
</head>
<body>
  <div class="container my-3">
    <div class="app-header">
      <div>
        <h2 class="app-title">Gestionnaire Armes / Munitions / Radios ‚Äî Production</h2>
        <div class="muted-note">GTRP ‚Äî interface mobile & desktop. Profite du dark mode pour bosser la nuit ‚ú¶</div>
      </div>
      <div style="display:flex;gap:10px;align-items:center;">
        <div class="muted-pill">Serveur : 5M ‚Ä¢ GTRP</div>
        <button id="themeToggle" class="theme-toggle" aria-pressed="false" title="Basculer le th√®me">
          <span id="themeIcon">üåô</span>
          <span id="themeLabel">Dark</span>
        </button>
      </div>
    </div>

    <!-- USERS -->
    <div class="card mb-3">
      <div class="card-header bg-transparent">Personnages & emprunts</div>
      <div class="card-body">
        <form id="addUserForm" class="row g-2 mb-3">
          <div class="col-8 col-sm-9">
            <input id="userName" class="form-control" placeholder="Nom du personnage (ex: Dupont)" required>
          </div>
          <div class="col-4 col-sm-3 d-grid">
            <button class="btn btn-success" type="submit">Ajouter</button>
          </div>
        </form>

        <!-- Desktop Table -->
        <div class="table-responsive desktop-only">
          <table class="table table-striped align-middle table-small" id="userTable">
            <thead>
              <tr>
                <th>Nom</th>
                <th class="text-center">Arme</th>
                <th class="text-center">Munitions</th>
                <th class="text-center">Radio</th>
                <th class="text-center">Actions</th>
              </tr>
            </thead>
            <tbody id="userTableBody"></tbody>
          </table>
        </div>

        <!-- Mobile Cards -->
        <div id="userCards" class="mobile-only"></div>

        <div class="muted-note mt-2">
          Les √©l√©ments (arme, munitions, radio) sont toggleables. UI optimis√©e pour mobile.
        </div>
      </div>
    </div>

    <!-- PRODUCTION -->
    <div class="card mb-4">
      <div class="card-header bg-transparent">Production</div>
      <div class="card-body">
        <div class="row g-2 mb-2">
          <div class="col-12 col-md-5">
            <input id="prodName" class="form-control" placeholder="Nom de l'item (ex: Poudre √† canon)">
          </div>
          <div class="col-6 col-md-2">
            <select id="prodPriceType" class="form-control">
              <option value="euro">euro</option>
              <option value="material">material</option>
            </select>
          </div>
          <div class="col-6 col-md-2">
            <input id="prodPriceValue" class="form-control" placeholder="Prix (ex: 12.5)">
          </div>
          <div class="col-6 col-md-2">
            <input id="prodQty" type="number" class="form-control" placeholder="Quantit√©" value="0" min="0">
          </div>
          <div class="col-6 col-md-1 d-grid">
            <button id="addProdBtn" type="button" class="btn btn-primary">Ajouter</button>
          </div>
        </div>

        <!-- Desktop Table -->
        <div class="table-responsive desktop-only">
          <table class="table table-bordered align-middle table-small" id="productionTable">
            <thead>
              <tr>
                <th>Nom</th>
                <th>Type</th>
                <th>Prix</th>
                <th>Quantit√©</th>
                <th>Total</th>
                <th class="text-center">Actions</th>
              </tr>
            </thead>
            <tbody id="productionBody"></tbody>
          </table>
        </div>

        <!-- Mobile Cards -->
        <div id="productionCards" class="mobile-only"></div>

        <div class="muted-note mt-2">
          Si <code>price_type</code> = <code>euro</code> ‚Üí total = prix * quantit√©. Tu peux √©diter prix/quantit√©/total. Le total peut √™tre forc√©, et le prix recalcul√© automatiquement si n√©cessaire.
        </div>
      </div>
    </div>
  </div>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

  <script>
    /* ---------------------------
       CONFIG SUPABASE
       --------------------------- */
    const SUPABASE_URL = "https://ldhxyloqdtplevdkgnah.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxkaHh5bG9xZHRwbGV2ZGtnbmFoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEyMTg5NjAsImV4cCI6MjA3Njc5NDk2MH0.pnoppZtVEP3uDrMEfauPAMMB93EmGO5Ur1pg4OY99-o";
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    /* ---------------------------
       THEME: dark / light toggle (persist)
       --------------------------- */
    const bodyEl = document.body;
    const themeToggleBtn = document.getElementById('themeToggle');
    const themeIcon = document.getElementById('themeIcon');
    const themeLabel = document.getElementById('themeLabel');

    function applyTheme(theme) {
      if (theme === 'dark') {
        bodyEl.classList.add('theme-dark');
        themeIcon.textContent = 'üåû';
        themeLabel.textContent = 'Light';
        themeToggleBtn.setAttribute('aria-pressed', 'true');
      } else {
        bodyEl.classList.remove('theme-dark');
        themeIcon.textContent = 'üåô';
        themeLabel.textContent = 'Dark';
        themeToggleBtn.setAttribute('aria-pressed', 'false');
      }
    }

    // init theme from localStorage or prefers-color-scheme
    const savedTheme = localStorage.getItem('app_theme');
    if (savedTheme) {
      applyTheme(savedTheme);
    } else {
      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      applyTheme(prefersDark ? 'dark' : 'light');
    }

    themeToggleBtn.addEventListener('click', () => {
      const newTheme = bodyEl.classList.contains('theme-dark') ? 'light' : 'dark';
      applyTheme(newTheme);
      localStorage.setItem('app_theme', newTheme);
    });

    /* ---------------------------
       DOM refs
       --------------------------- */
    const userTableBody = document.getElementById('userTableBody');
    const userCards = document.getElementById('userCards');
    const productionBody = document.getElementById('productionBody');
    const productionCards = document.getElementById('productionCards');
    const addUserForm = document.getElementById('addUserForm');
    const addProdBtn = document.getElementById('addProdBtn');

    /* ---------------------------
       UTIL
       --------------------------- */
    function escapeHtml(unsafe) {
      if (unsafe === null || unsafe === undefined) return '';
      return String(unsafe)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    /* ---------------------------
       USERS: load / render
       --------------------------- */
    async function loadUsers() {
      try {
        const { data, error } = await supabaseClient.from('users').select('*').order('id', { ascending: true });
        if (error) throw error;
        renderUsers(data || []);
      } catch (err) {
        console.error('Erreur loadUsers', err);
      }
    }

    function renderUsers(users) {
      userTableBody.innerHTML = '';
      users.forEach(user => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(user.name)}</td>
          <td class="text-center"><input type="checkbox" ${user.weapon_given ? 'checked' : ''} data-type="weapon" data-id="${user.id}" class="form-check-input"></td>
          <td class="text-center"><input type="checkbox" ${user.ammo_given ? 'checked' : ''} data-type="ammo" data-id="${user.id}" class="form-check-input"></td>
          <td class="text-center"><input type="checkbox" ${user.radio_given ? 'checked' : ''} data-type="radio" data-id="${user.id}" class="form-check-input"></td>
          <td class="text-center"><button class="btn btn-sm btn-danger" data-delete-id="${user.id}">Suppr</button></td>
        `;
        userTableBody.appendChild(tr);
      });

      userTableBody.querySelectorAll('input[type="checkbox"]').forEach(cb => {
        cb.onchange = async (ev) => {
          const id = cb.dataset.id;
          const type = cb.dataset.type;
          const checked = cb.checked;
          const changes = {};
          if (type === 'weapon') changes.weapon_given = checked;
          if (type === 'ammo') changes.ammo_given = checked;
          if (type === 'radio') changes.radio_given = checked;
          await updateUserField(id, changes);
        };
      });
      userTableBody.querySelectorAll('button[data-delete-id]').forEach(btn => {
        btn.onclick = async () => {
          const id = btn.dataset.deleteId;
          if (!confirm('Supprimer ce personnage ?')) return;
          await supabaseClient.from('users').delete().eq('id', id);
          await loadUsers();
        };
      });

      // Mobile
      userCards.innerHTML = '';
      users.forEach(user => {
        const div = document.createElement('div');
        div.className = 'mobile-card';
        div.innerHTML = `
          <div class="d-flex justify-content-between align-items-start">
            <strong>${escapeHtml(user.name)}</strong>
            <div>
              <button class="btn btn-sm btn-danger" data-delete-id="${user.id}">Suppr</button>
            </div>
          </div>
          <div class="mobile-row mt-2">
            <div><label class="form-check-label">Arme<br><input type="checkbox" data-type="weapon" data-id="${user.id}" ${user.weapon_given ? 'checked' : ''} class="form-check-input"></label></div>
            <div><label class="form-check-label">Munitions<br><input type="checkbox" data-type="ammo" data-id="${user.id}" ${user.ammo_given ? 'checked' : ''} class="form-check-input"></label></div>
            <div><label class="form-check-label">Radio<br><input type="checkbox" data-type="radio" data-id="${user.id}" ${user.radio_given ? 'checked' : ''} class="form-check-input"></label></div>
          </div>
        `;
        userCards.appendChild(div);

        div.querySelectorAll('input[type="checkbox"]').forEach(cb => {
          cb.onchange = async () => {
            const id = cb.dataset.id;
            const type = cb.dataset.type;
            const checked = cb.checked;
            const changes = {};
            if (type === 'weapon') changes.weapon_given = checked;
            if (type === 'ammo') changes.ammo_given = checked;
            if (type === 'radio') changes.radio_given = checked;
            await updateUserField(id, changes);
          };
        });
        div.querySelector('button[data-delete-id]').onclick = async () => {
          const id = div.querySelector('button[data-delete-id]').dataset.deleteId;
          if (!confirm('Supprimer ce personnage ?')) return;
          await supabaseClient.from('users').delete().eq('id', id);
          await loadUsers();
        };
      });
    }

    async function updateUserField(userId, changes) {
      try {
        const { error } = await supabaseClient.from('users').update(changes).eq('id', userId);
        if (error) throw error;
        await loadUsers();
      } catch (err) {
        console.error('Erreur updateUserField', err);
      }
    }

    /* ---------------------------
       PRODUCTION: load / render / edit
       --------------------------- */
    async function loadProduction() {
      try {
        const { data, error } = await supabaseClient.from('production').select('*').order('id', { ascending: true });
        if (error) throw error;
        renderProduction(data || []);
      } catch (err) {
        console.error('Erreur loadProduction', err);
      }
    }

    function renderProduction(items) {
      productionBody.innerHTML = '';
      items.forEach(item => {
        const tr = document.createElement('tr');
        const priceDisplay = item.price_type === 'euro' ? (Number(item.price_value) || 0) : (item.price_value ?? '');
        const total = (item.price_type === 'euro') ? (Number(item.price_value || 0) * Number(item.quantity || 0)) : null;
        const totalDisplay = (total !== null && !isNaN(total)) ? total : '';

        tr.innerHTML = `
          <td><input class="form-control form-control-sm prod-name production-input" value="${escapeHtml(item.name ?? '')}" data-id="${item.id}"></td>
          <td>
            <select class="form-control form-control-sm prod-type production-input" data-id="${item.id}">
              <option value="euro" ${item.price_type === 'euro' ? 'selected' : ''}>euro</option>
              <option value="material" ${item.price_type === 'material' ? 'selected' : ''}>material</option>
            </select>
          </td>
          <td><input class="form-control form-control-sm prod-price production-input" value="${priceDisplay}" data-id="${item.id}"></td>
          <td><input type="number" min="0" class="form-control form-control-sm prod-qty production-input" value="${item.quantity ?? 0}" data-id="${item.id}"></td>
          <td><input class="form-control form-control-sm prod-total production-input" value="${totalDisplay}" data-id="${item.id}"></td>
          <td class="text-center">
            <button class="btn btn-sm btn-primary btn-save" data-id="${item.id}">Enregistrer</button>
            <button class="btn btn-sm btn-danger btn-del" data-id="${item.id}">Suppr</button>
          </td>
        `;
        productionBody.appendChild(tr);

        // recalc handlers
        const priceInput = tr.querySelector('.prod-price');
        const qtyInput = tr.querySelector('.prod-qty');
        const totalInput = tr.querySelector('.prod-total');
        const typeSelect = tr.querySelector('.prod-type');

        function recalcFromPriceQty() {
          if (typeSelect.value === 'euro') {
            const p = Number(priceInput.value || 0);
            const q = Number(qtyInput.value || 0);
            const t = (isNaN(p) || isNaN(q)) ? '' : (p * q);
            totalInput.value = t === '' ? '' : Number(t.toFixed(2));
          }
        }
        function recalcFromTotal() {
          if (typeSelect.value === 'euro') {
            const t = Number(totalInput.value || 0);
            const q = Number(qtyInput.value || 0);
            if (q > 0 && !isNaN(t)) {
              const p = t / q;
              priceInput.value = Number(p.toFixed(2));
            }
          }
        }
        priceInput.oninput = recalcFromPriceQty;
        qtyInput.oninput = recalcFromPriceQty;
        totalInput.oninput = recalcFromTotal;
        typeSelect.onchange = recalcFromPriceQty;

        tr.querySelector('.btn-save').onclick = async () => {
          const id = item.id;
          const name = tr.querySelector('.prod-name').value.trim();
          const price_type = tr.querySelector('.prod-type').value;
          const price_value_raw = tr.querySelector('.prod-price').value.trim();
          const qty = Number(tr.querySelector('.prod-qty').value || 0);
          const total_raw = tr.querySelector('.prod-total').value.trim();

          let price_value = price_value_raw === '' ? null : price_value_raw;
          if (price_type === 'euro') {
            const totalNum = Number(total_raw);
            if (!isNaN(totalNum) && qty > 0) {
              price_value = (totalNum / qty).toFixed(2);
            }
          }

          try {
            const { error } = await supabaseClient.from('production').update({
              name, price_type, price_value, quantity: qty
            }).eq('id', id);
            if (error) throw error;
            await loadProduction();
          } catch (err) {
            console.error('Erreur save production', err);
          }
        };

        tr.querySelector('.btn-del').onclick = async () => {
          if (!confirm('Supprimer cet item de production ?')) return;
          try {
            const { error } = await supabaseClient.from('production').delete().eq('id', item.id);
            if (error) throw error;
            await loadProduction();
          } catch (err) {
            console.error('Erreur delete production', err);
          }
        };
      });

      // mobile cards
      productionCards.innerHTML = '';
      items.forEach(item => {
        const div = document.createElement('div');
        div.className = 'mobile-card';
        const priceVal = item.price_type === 'euro' ? (Number(item.price_value || 0).toFixed(2)) : (item.price_value ?? '');
        const totalVal = (item.price_type === 'euro') ? ( (Number(item.price_value || 0) * Number(item.quantity || 0)).toFixed(2) ) : '';
        div.innerHTML = `
          <div class="d-flex justify-content-between align-items-center">
            <input class="form-control form-control-sm prod-name production-input" value="${escapeHtml(item.name ?? '')}" data-id="${item.id}">
          </div>
          <div class="mobile-row mt-2">
            <div>
              <label class="form-label small">Type</label>
              <select class="form-control form-control-sm prod-type production-input" data-id="${item.id}">
                <option value="euro" ${item.price_type === 'euro' ? 'selected' : ''}>euro</option>
                <option value="material" ${item.price_type === 'material' ? 'selected' : ''}>material</option>
              </select>
            </div>
            <div>
              <label class="form-label small">Prix</label>
              <input class="form-control form-control-sm prod-price production-input" value="${priceVal}" data-id="${item.id}">
            </div>
            <div>
              <label class="form-label small">Quantit√©</label>
              <input type="number" min="0" class="form-control form-control-sm prod-qty production-input" value="${item.quantity ?? 0}" data-id="${item.id}">
            </div>
            <div>
              <label class="form-label small">Total</label>
              <input class="form-control form-control-sm prod-total production-input" value="${totalVal}" data-id="${item.id}">
            </div>
          </div>
          <div class="mobile-actions">
            <button class="btn btn-sm btn-primary btn-save" data-id="${item.id}">Enregistrer</button>
            <button class="btn btn-sm btn-danger btn-del" data-id="${item.id}">Suppr</button>
          </div>
        `;
        productionCards.appendChild(div);

        const priceInput = div.querySelector('.prod-price');
        const qtyInput = div.querySelector('.prod-qty');
        const totalInput = div.querySelector('.prod-total');
        const typeSelect = div.querySelector('.prod-type');

        function recalcFromPriceQtyMobile() {
          if (typeSelect.value === 'euro') {
            const p = Number(priceInput.value || 0);
            const q = Number(qtyInput.value || 0);
            const t = (isNaN(p) || isNaN(q)) ? '' : (p * q);
            totalInput.value = t === '' ? '' : Number(t.toFixed(2));
          }
        }
        function recalcFromTotalMobile() {
          if (typeSelect.value === 'euro') {
            const t = Number(totalInput.value || 0);
            const q = Number(qtyInput.value || 0);
            if (q > 0 && !isNaN(t)) {
              const p = t / q;
              priceInput.value = Number(p.toFixed(2));
            }
          }
        }

        priceInput.oninput = recalcFromPriceQtyMobile;
        qtyInput.oninput = recalcFromPriceQtyMobile;
        totalInput.oninput = recalcFromTotalMobile;
        typeSelect.onchange = recalcFromPriceQtyMobile;

        div.querySelector('.btn-save').onclick = async () => {
          const id = item.id;
          const name = div.querySelector('.prod-name').value.trim();
          const price_type = div.querySelector('.prod-type').value;
          const price_value_raw = div.querySelector('.prod-price').value.trim();
          const qty = Number(div.querySelector('.prod-qty').value || 0);
          const total_raw = div.querySelector('.prod-total').value.trim();

          let price_value = price_value_raw === '' ? null : price_value_raw;
          if (price_type === 'euro') {
            const totalNum = Number(total_raw);
            if (!isNaN(totalNum) && qty > 0) {
              price_value = (totalNum / qty).toFixed(2);
            }
          }

          try {
            const { error } = await supabaseClient.from('production').update({
              name, price_type, price_value, quantity: qty
            }).eq('id', id);
            if (error) throw error;
            await loadProduction();
          } catch (err) {
            console.error('Erreur save production', err);
          }
        };

        div.querySelector('.btn-del').onclick = async () => {
          if (!confirm('Supprimer cet item de production ?')) return;
          try {
            const { error } = await supabaseClient.from('production').delete().eq('id', item.id);
            if (error) throw error;
            await loadProduction();
          } catch (err) {
            console.error('Erreur delete production', err);
          }
        };
      });
    }

    /* ---------------------------
       Add user & production
       --------------------------- */
    addUserForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = document.getElementById('userName').value.trim();
      if (!name) return alert('Nom requis');
      try {
        const { error } = await supabaseClient.from('users').insert([{ name, weapon_given: false, ammo_given: false, radio_given: false }]);
        if (error) throw error;
        document.getElementById('userName').value = '';
        await loadUsers();
      } catch (err) {
        console.error('Erreur add user', err);
      }
    });

    addProdBtn.addEventListener('click', async () => {
      const name = document.getElementById('prodName').value.trim();
      const priceType = document.getElementById('prodPriceType').value;
      const priceValueRaw = document.getElementById('prodPriceValue').value.trim();
      const qty = Number(document.getElementById('prodQty').value || 0);
      if (!name) return alert('Nom requis pour production');
      try {
        const priceValue = priceValueRaw === '' ? null : priceValueRaw;
        const { error } = await supabaseClient.from('production').insert([{ name, price_type: priceType, price_value: priceValue, quantity: qty }]);
        if (error) throw error;
        document.getElementById('prodName').value = '';
        document.getElementById('prodPriceValue').value = '';
        document.getElementById('prodQty').value = 0;
        await loadProduction();
      } catch (err) {
        console.error('Erreur add production', err);
      }
    });

    /* ---------------------------
       Realtime (optional)
       --------------------------- */
    function setupRealtime() {
      try {
        supabaseClient.channel('users-ch')
          .on('postgres_changes', { event: '*', schema: 'public', table: 'users' }, () => loadUsers())
          .subscribe();

        supabaseClient.channel('production-ch')
          .on('postgres_changes', { event: '*', schema: 'public', table: 'production' }, () => loadProduction())
          .subscribe();
      } catch (err) {
        console.warn('Realtime non disponible', err);
      }
    }

    /* ---------------------------
       INIT
       --------------------------- */
    async function init() {
      await loadUsers();
      await loadProduction();
      setupRealtime();
    }
    init();

    // UX: re-render after orientation change so mobile/desktop view snaps correctly
    window.addEventListener('orientationchange', () => { setTimeout(() => { loadUsers(); loadProduction(); }, 300); });

  </script>
</body>
</html>
