<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Beltran Leyva — Recel Business Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body {
      background: #0b0b0b;
      color: #e6e6e6;
      font-family: 'Segoe UI', sans-serif;
      padding: 25px;
    }

    h1, h2 {
      text-align: center;
      color: #d4af37;
      margin-bottom: 12px;
      text-shadow: 0 0 8px #000;
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 18px;
      margin-bottom: 40px;
    }

    .card {
      background: #161616;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px #000;
      text-align: center;
      border: 1px solid #333;
    }

    .card-title {
      font-size: 14px;
      opacity: 0.7;
    }

    .value {
      font-size: 26px;
      font-weight: bold;
      margin-top: 8px;
    }

    .positive { color: #29ff78; }
    .negative { color: #ff4949; }

    table {
      width: 100%;
      border-collapse: collapse;
      background: #161616;
      margin-bottom: 30px;
      font-size: 14px;
      border: 1px solid #333;
    }

    th {
      background: #2d0000;
      color: #d4af37;
      padding: 10px;
      border: 1px solid #333;
    }

    td {
      padding: 8px;
      border: 1px solid #333;
    }

    .form-container {
      background: #1b1b1b;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 40px;
      border: 1px solid #333;
    }

    input, select {
      width: 100%;
      padding: 10px;
      background: #222;
      color: white;
      border: 1px solid #444;
      border-radius: 5px;
      margin-bottom: 12px;
    }

    input[readonly] {
      background: #111;
      color: #999;
    }

    button {
      width: 100%;
      padding: 12px;
      background: #8b0000;
      color: #d4af37;
      border: none;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      border-radius: 6px;
      margin-top: 10px;
    }

    button:hover {
      background: #d4af37;
      color: #8b0000;
    }

    .filters {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
    }

    .flex-row {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }

  </style>
</head>
<body>

<h1>RECEL BUSINESS — BELTRAN LEYVA</h1>

<!-- DASHBOARD -->
<div class="dashboard-grid">
  <div class="card">
    <div class="card-title">Total Achat (gangs)</div>
    <div id="totalBuy" class="value">$0</div>
  </div>
  <div class="card">
    <div class="card-title">Valeur Vente (recel)</div>
    <div id="totalSell" class="value">$0</div>
  </div>
  <div class="card">
    <div class="card-title">Profit Global</div>
    <div id="totalProfit" class="value positive">$0</div>
  </div>
</div>

<!-- PAR GANG -->
<h2>Résumé par Gang</h2>
<table>
  <thead>
    <tr>
      <th>Gang</th>
      <th>Achat total</th>
      <th>Vente totale</th>
      <th>Profit</th>
      <th>Transactions</th>
    </tr>
  </thead>
  <tbody id="gangTable"></tbody>
</table>

<!-- PAR CATÉGORIE -->
<h2>Résumé par Catégorie</h2>
<table>
  <thead>
    <tr>
      <th>Catégorie</th>
      <th>Achat total</th>
      <th>Vente totale</th>
      <th>Profit</th>
      <th>Quantité totale</th>
    </tr>
  </thead>
  <tbody id="categoryTable"></tbody>
</table>

<!-- AJOUT TRANSACTION -->
<h2>Ajouter un achat</h2>
<div class="form-container">

  <div class="flex-row">
    <div>
      <label>Gang</label>
      <select id="gang">
        <option value="">Choisir un gang</option>
        <option>Ballas</option>
        <option>Vagos</option>
        <option>Families</option>
        <option>Marabunta</option>
        <option>Bloods</option>
        <option>Crips</option>
        <option>Triades</option>
        <option>Mafia</option>
      </select>
    </div>

    <div>
      <label>Objet</label>
      <select id="itemSelect">
        <option value="">Choisir un item</option>
      </select>
    </div>
  </div>

  <div class="flex-row">
    <div>
      <label>Catégorie</label>
      <input id="category" readonly>
    </div>
    <div>
      <label>Nom</label>
      <input id="name" readonly>
    </div>
  </div>

  <div class="flex-row">
    <div>
      <label>Prix Achat</label>
      <input id="price_buy" readonly>
    </div>
    <div>
      <label>Prix Vente</label>
      <input id="price_sell" readonly>
    </div>
  </div>

  <label>Quantité</label>
  <input type="number" id="qty" placeholder="Quantité">

  <button id="addBtn">Ajouter la transaction</button>

</div>

<!-- FILTRES -->
<h2>Détails des Transactions</h2>
<div class="filters">
  <select id="filterGang"><option value="">Filtrer par gang</option></select>
  <select id="filterCategory"><option value="">Filtrer par catégorie</option></select>
</div>

<!-- TABLE DES TRANSACTIONS -->
<table>
  <thead>
    <tr>
      <th>Date</th>
      <th>Gang</th>
      <th>Catégorie</th>
      <th>Objet</th>
      <th>Achat (unité)</th>
      <th>Vente (unité)</th>
      <th>Quantité</th>
      <th>Total Achat</th>
      <th>Total Vente</th>
      <th>Profit</th>
    </tr>
  </thead>
  <tbody id="itemsTable"></tbody>
</table>


<script>
const supabaseClient = supabase.createClient(
  "https://ldhxyloqdtplevdkgnah.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxkaHh5bG9xZHRwbGV2ZGtnbmFoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEyMTg5NjAsImV4cCI6MjA3Njc5NDk2MH0.pnoppZtVEP3uDrMEfauPAMMB93EmGO5Ur1pg4OY99-o"
);

let catalog = [];
let transactions = [];

function money(n) { return "$" + Number(n).toLocaleString("fr-FR"); }

async function loadCatalog() {
  const { data } = await supabaseClient.from("catalog").select("*").order("category");
  catalog = data || [];

  const sel = document.getElementById("itemSelect");
  sel.innerHTML = '<option value="">Choisir un item</option>';

  catalog.forEach(i => {
    sel.innerHTML += `<option value="${i.id}">
      [${i.category}] ${i.name} — ${money(i.price_buy)}
    </option>`;
  });
}

document.getElementById("itemSelect").onchange = () => {
  const id = Number(document.getElementById("itemSelect").value);
  const item = catalog.find(i => i.id === id);

  document.getElementById("category").value = item?.category || "";
  document.getElementById("name").value = item?.name || "";
  document.getElementById("price_buy").value = item?.price_buy || "";
  document.getElementById("price_sell").value = item?.price_sell || "";
};

async function loadTransactions() {
  const { data } = await supabaseClient
    .from("items")
    .select("*, catalog(*)")
    .order("created_at", { ascending: false });

  transactions = data || [];

  renderDashboard();
  renderGangTable();
  renderCategoryTable();
  loadFilters();
  renderTransactionsTable();
}

function renderDashboard() {
  let buy = 0, sell = 0;

  transactions.forEach(t => {
    buy += t.catalog.price_buy * t.qty;
    sell += t.catalog.price_sell * t.qty;
  });

  document.getElementById("totalBuy").textContent = money(buy);
  document.getElementById("totalSell").textContent = money(sell);

  const profit = sell - buy;
  const profitEl = document.getElementById("totalProfit");

  profitEl.textContent = money(profit);
  profitEl.className = "value " + (profit >= 0 ? "positive" : "negative");
}

function renderGangTable() {
  const tbody = document.getElementById("gangTable");
  tbody.innerHTML = "";

  const gangs = {};

  transactions.forEach(t => {
    if (!gangs[t.gang]) gangs[t.gang] = { buy: 0, sell: 0, qty: 0 };

    gangs[t.gang].buy += t.catalog.price_buy * t.qty;
    gangs[t.gang].sell += t.catalog.price_sell * t.qty;
    gangs[t.gang].qty++;
  });

  Object.entries(gangs).forEach(([gang, v]) => {
    const profit = v.sell - v.buy;
    tbody.innerHTML += `
      <tr>
        <td>${gang}</td>
        <td>${money(v.buy)}</td>
        <td>${money(v.sell)}</td>
        <td class="${profit >= 0 ? 'positive' : 'negative'}">${money(profit)}</td>
        <td>${v.qty}</td>
      </tr>
    `;
  });
}

function renderCategoryTable() {
  const tbody = document.getElementById("categoryTable");
  tbody.innerHTML = "";

  const cats = {};

  transactions.forEach(t => {
    if (!cats[t.catalog.category])
      cats[t.catalog.category] = { buy: 0, sell: 0, qty: 0 };

    cats[t.catalog.category].buy += t.catalog.price_buy * t.qty;
    cats[t.catalog.category].sell += t.catalog.price_sell * t.qty;
    cats[t.catalog.category].qty += t.qty;
  });

  Object.entries(cats).forEach(([cat, v]) => {
    const profit = v.sell - v.buy;

    tbody.innerHTML += `
      <tr>
        <td>${cat}</td>
        <td>${money(v.buy)}</td>
        <td>${money(v.sell)}</td>
        <td class="${profit >= 0 ? 'positive' : 'negative'}">${money(profit)}</td>
        <td>${v.qty}</td>
      </tr>
    `;
  });
}

function loadFilters() {
  const gangSel = document.getElementById("filterGang");
  const catSel = document.getElementById("filterCategory");

  const gangs = [...new Set(transactions.map(t => t.gang))];
  const cats = [...new Set(transactions.map(t => t.catalog.category))];

  gangSel.innerHTML = '<option value="">Filtrer par gang</option>';
  catSel.innerHTML = '<option value="">Filtrer par catégorie</option>';

  gangs.forEach(g => gangSel.innerHTML += `<option>${g}</option>`);
  cats.forEach(c => catSel.innerHTML += `<option>${c}</option>`);

  gangSel.onchange = renderTransactionsTable;
  catSel.onchange = renderTransactionsTable;
}

function renderTransactionsTable() {
  const gangFilter = document.getElementById("filterGang").value;
  const catFilter = document.getElementById("filterCategory").value;
  const tbody = document.getElementById("itemsTable");

  tbody.innerHTML = "";

  transactions
    .filter(t => !gangFilter || t.gang === gangFilter)
    .filter(t => !catFilter || t.catalog.category === catFilter)
    .forEach(t => {
      const buy = t.catalog.price_buy * t.qty;
      const sell = t.catalog.price_sell * t.qty;
      const profit = sell - buy;

      tbody.innerHTML += `
        <tr>
          <td>${new Date(t.created_at).toLocaleDateString()}</td>
          <td>${t.gang}</td>
          <td>${t.catalog.category}</td>
          <td>${t.catalog.name}</td>
          <td>${money(t.catalog.price_buy)}</td>
          <td>${money(t.catalog.price_sell)}</td>
          <td>
            <input type="number" 
                   class="edit-qty" 
                   data-id="${t.id}" 
                   value="${t.qty}"
                   style="width:70px">
          </td>
          <td>${money(buy)}</td>
          <td>${money(sell)}</td>
          <td class="${profit >= 0 ? 'positive' : 'negative'}">${money(profit)}</td>
        </tr>
      `;
    });

  // MODIFICATION QUANTITÉ DIRECTEMENT DANS LE FILTRE
  document.querySelectorAll(".edit-qty").forEach(input => {
    input.onchange = async () => {
      const id = input.dataset.id;
      const newQty = Number(input.value);

      if (newQty < 0) return alert("Quantité invalide.");

      await supabaseClient.from("items").update({ qty: newQty }).eq("id", id);

      loadTransactions();
    };
  });
}

document.getElementById("addBtn").onclick = async () => {
  const gang = document.getElementById("gang").value;
  const itemId = Number(document.getElementById("itemSelect").value);
  const qty = Number(document.getElementById("qty").value);

  if (!gang || !itemId || qty <= 0) {
    alert("Remplis correctement toutes les informations.");
    return;
  }

  await supabaseClient.from("items").insert([{ catalog_id: itemId, gang, qty }]);

  document.getElementById("qty").value = "";
  await loadTransactions();
};

(async function init() {
  await loadCatalog();
  await loadTransactions();
})();
</script>

</body>
</html>
