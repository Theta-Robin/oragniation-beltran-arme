<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Gestion Inventaire</title>
<style>
    body {
        font-family: Arial, sans-serif;
        padding: 20px;
        background-color: #f4f4f4;
    }
    h1, h2 { text-align: center; }
    table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 40px;
        background-color: #fff;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    th, td {
        border: 1px solid #ddd;
        padding: 10px;
        text-align: left;
    }
    th {
        background-color: #3498db;
        color: white;
    }
    tr:nth-child(even) { background-color: #f9f9f9; }
    tr:hover { background-color: #f1f1f1; }
    input[type="text"], input[type="number"] {
        width: 100%;
        box-sizing: border-box;
        padding: 5px;
    }
    input.stock-input {
        color: white;
        font-weight: bold;
        text-align: center;
    }
    .red { background-color: #e74c3c; }
    .orange { background-color: #f39c12; }
    .green { background-color: #2ecc71; }
    button {
        padding: 6px 12px;
        background-color: #2ecc71;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }
    button:hover { background-color: #27ae60; }
</style>
</head>
<body>

<h1>Gestion Inventaire</h1>
<button style="padding:10px 20px; background-color:#3498db; color:white; border:none; border-radius:5px; cursor:pointer;" onclick="window.location.href='index.html'">Retour</button>

<h2>Armes</h2>
<table id="weaponsTable">
    <thead>
        <tr>
            <th>Nom</th>
            <th>Prix Achat</th>
            <th>Prix Vente</th>
            <th>Stock</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<h2>Accessoires</h2>
<table id="accessoriesTable">
    <thead>
        <tr>
            <th>Nom</th>
            <th>Stock</th>
            <th>Coût de fabrication</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<h2>Munitions</h2>
<table id="ammoTable">
    <thead>
        <tr>
            <th>Nom</th>
            <th>Stock</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<h2>Matériaux</h2>
<table id="materialsTable">
    <thead>
        <tr>
            <th>Nom</th>
            <th>Stock</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

const SUPABASE_URL = "https://ldhxyloqdtplevdkgnah.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxkaHh5bG9xZHRwbGV2ZGtnbmFoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEyMTg5NjAsImV4cCI6MjA3Njc5NDk2MH0.pnoppZtVEP3uDrMEfauPAMMB93EmGO5Ur1pg4OY99-o"; // <-- remplace par ta clé ANON
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// --- Code couleur pour les munitions ---
function getAmmoColor(name, stock) {
    stock = parseInt(stock) || 0;
    switch(name) {
        case '7.62':
            if(stock < 2000) return 'red';
            if(stock < 3000) return 'orange';
            return 'green';
        case '9mm':
            if(stock < 1000) return 'red';
            if(stock >= 1500 && stock <= 2000) return 'orange';
            if(stock > 2000) return 'green';
            return 'green';
        case '.38 LC':
            if(stock < 1000) return 'red';
            if(stock <= 1500) return 'orange';
            if(stock > 1500) return 'green';
            return 'green';
        case '45 ACP':
            if(stock < 1000) return 'red';
            if(stock < 3000) return 'orange';
            if(stock >= 3000) return 'green';
            return 'green';
        case '50 AE':
            if(stock < 20) return 'red';
            if(stock < 30) return 'orange';
            return 'green';
        default:
            if(stock < 100) return 'red';
            if(stock < 200) return 'orange';
            return 'green';
    }
}

// --- Armes ---
async function fetchWeapons() {
    const { data, error } = await supabase.from('weapons').select('*');
    if(error){ console.error(error); return; }
    const tbody = document.querySelector("#weaponsTable tbody");
    tbody.innerHTML = '';
    data.forEach(w => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><input type="text" value="${w.name}" /></td>
            <td><input type="number" value="${w.buy_price}" /></td>
            <td><input type="number" value="${w.sell_price || ''}" /></td>
            <td><input type="number" value="${w.stock}" /></td>
            <td><button onclick="updateWeapon('${w.id}', this)">Sauvegarder</button></td>
        `;
        tbody.appendChild(tr);
    });
}
window.updateWeapon = async function(id, btn) {
    const tr = btn.closest('tr');
    const name = tr.children[0].querySelector('input').value;
    const buy_price = parseInt(tr.children[1].querySelector('input').value) || 0;
    const sell_price = parseInt(tr.children[2].querySelector('input').value) || 0;
    const stock = parseInt(tr.children[3].querySelector('input').value) || 0;
    const { error } = await supabase.from('weapons').update({ name, buy_price, sell_price, stock }).eq('id', id);
    if(error){ alert('Erreur : ' + error.message); } else { alert('Modifié avec succès !'); }
}

// --- Accessoires ---
function getAccessoryColor(name, stock) {
    stock = parseInt(stock) || 0;
    name = name.toLowerCase();
    if(name.includes('crosse') || name.includes('cross')) {
        if(stock < 20) return 'red';
        if(stock <= 30) return 'orange';
        if(stock > 30) return 'green';
        return 'orange';
    }
    if(name.includes('canon') || name.includes('viseur')) {
        if(stock < 1) return 'red';
        if(stock <= 2) return 'green';
        return 'green';
    }
    if(name.includes('chargeur')) {
        if(stock < 20) return 'red';
        if(stock <= 30) return 'orange';
        if(stock > 50) return 'green';
        return 'orange';
    }
     if(name.includes('corps d\'armes')) {
        if(stock < 20) return 'red';
        if(stock <= 30) return 'orange';
        if(stock > 50) return 'green';
        return 'orange';
    }
    
    return 'green'; // par défaut
}

async function fetchAccessories() {
    const { data, error } = await supabase.from('accessories').select('*');
    if(error){ console.error(error); return; }
    const tbody = document.querySelector("#accessoriesTable tbody");
    tbody.innerHTML = '';
    data.forEach(a => {
        const colorClass = getAccessoryColor(a.name, a.stock);
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><input type="text" value="${a.name}" /></td>
            <td><input type="number" class="stock-input ${colorClass}" value="${a.stock}" /></td>
            <td><input type="text" value="${a.craft_cost}" /></td>
            <td><button onclick="updateAccessory('${a.id}', this)">Sauvegarder</button></td>
        `;
        tbody.appendChild(tr);
    });
}

window.updateAccessory = async function(id, btn) {
    const tr = btn.closest('tr');
    const name = tr.children[0].querySelector('input').value;
    const stockInput = tr.children[1].querySelector('input');
    const stock = parseInt(stockInput.value) || 0;
    const craft_cost = tr.children[2].querySelector('input').value;

    const { error } = await supabase.from('accessories')
        .update({ name, stock, craft_cost })
        .eq('id', id);

    if(error){ 
        alert('Erreur : ' + error.message); 
    } else { 
        // Mise à jour couleur
        stockInput.className = `stock-input ${getAccessoryColor(name, stock)}`;
        alert('Modifié avec succès !'); 
    }
}

window.updateAccessory = async function(id, btn) {
    const tr = btn.closest('tr');
    const name = tr.children[0].querySelector('input').value;
    const stock = parseInt(tr.children[1].querySelector('input').value) || 0;
    const craft_cost = tr.children[2].querySelector('input').value;
    const { error } = await supabase.from('accessories').update({ name, stock, craft_cost }).eq('id', id);
    if(error){ alert('Erreur : ' + error.message); } else { alert('Modifié avec succès !'); }
}

// --- Munitions ---
async function fetchAmmo() {
    const { data, error } = await supabase.from('ammo').select('*');
    if(error){ console.error(error); return; }
    const tbody = document.querySelector("#ammoTable tbody");
    tbody.innerHTML = '';
    data.forEach(a => {
        const colorClass = getAmmoColor(a.name, a.stock);
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${a.name}</td>
            <td><input type="number" class="stock-input ${colorClass}" value="${a.stock}" /></td>
            <td><button onclick="updateAmmo('${a.id}', this)">Sauvegarder</button></td>
        `;
        tbody.appendChild(tr);
    });
}
window.updateAmmo = async function(id, btn) {
    const tr = btn.closest('tr');
    const stockInput = tr.children[1].querySelector('input');
    const stock = parseInt(stockInput.value) || 0;
    const name = tr.children[0].textContent;
    const { error } = await supabase.from('ammo').update({ stock }).eq('id', id);
    if(error){ alert('Erreur : ' + error.message); } 
    else { 
        stockInput.className = `stock-input ${getAmmoColor(name, stock)}`;
        alert('Modifié avec succès !'); 
    }
}

// --- Matériaux ---
async function fetchMaterials() {
    const { data, error } = await supabase.from('materials').select('*');
    if(error){ console.error(error); return; }
    const tbody = document.querySelector("#materialsTable tbody");
    tbody.innerHTML = '';
    data.forEach(m => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><input type="text" value="${m.name}" /></td>
            <td><input type="number" value="${m.stock}" /></td>
            <td><button onclick="updateMaterial('${m.id}', this)">Sauvegarder</button></td>
        `;
        tbody.appendChild(tr);
    });
}
window.updateMaterial = async function(id, btn) {
    const tr = btn.closest('tr');
    const name = tr.children[0].querySelector('input').value;
    const stock = parseInt(tr.children[1].querySelector('input').value) || 0;
    const { error } = await supabase.from('materials').update({ name, stock }).eq('id', id);
    if(error){ alert('Erreur : ' + error.message); } else { alert('Modifié avec succès !'); }
}

// --- Initialisation ---
fetchWeapons();
fetchAccessories();
fetchAmmo();
fetchMaterials();
</script>

</body>
</html>
